<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:WinsaneCS.ViewModels"
             xmlns:views="using:WinsaneCS.Views"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="WinsaneCS.Views.FeatureView"
             x:DataType="vm:FeatureViewModel">
    
    <UserControl.Resources>
        <!-- Group Template -->
        <DataTemplate x:Key="GroupTemplate" x:DataType="vm:ItemGroupViewModel">
            <ui:SettingsExpander Header="{Binding Header}"
                                 IsExpanded="True"
                                 ItemsSource="{Binding Items}"
                                 Margin="0,4,0,8">
                <ui:SettingsExpander.IconSource>
                     <ui:SymbolIconSource Symbol="Settings"/>
                </ui:SettingsExpander.IconSource>
                <ui:SettingsExpander.ItemTemplate>
                    <DataTemplate x:DataType="vm:ItemViewModel">
                        <ui:SettingsExpanderItem Content="{Binding Name}"
                                                 Description="{Binding Purpose}">
                            <ui:SettingsExpanderItem.Footer>
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <!-- Status text -->
                                    <TextBlock Text="{Binding StatusText}"
                                              VerticalAlignment="Center"
                                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                              IsVisible="{Binding StatusText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                    
                                    <!-- Loading indicator -->
                                    <ui:ProgressRing IsIndeterminate="True"
                                                    Width="20" Height="20"
                                                    IsVisible="{Binding IsLoading}"/>
                                    
                                    <!-- Toggle Switch -->
                                    <ToggleSwitch IsChecked="{Binding IsEnabled}"
                                                 IsVisible="{Binding ShowToggle}"
                                                 IsEnabled="{Binding !IsLoading}"
                                                 OnContent="On"
                                                 OffContent="Off"/>
                                    
                                    <!-- Run/Open Button -->
                                    <Button Content="{Binding ButtonText}"
                                           IsVisible="{Binding ShowRunButton}"
                                           IsEnabled="{Binding !IsLoading}"
                                           Command="{Binding ExecuteButtonCommand}"
                                           Classes="accent"/>
                                    
                                    <!-- Delete Button -->
                                    <Button Content="Delete"
                                           IsVisible="{Binding ShowDeleteButton}"
                                           IsEnabled="{Binding !IsLoading}"
                                           Command="{Binding DeleteCommand}"
                                           Foreground="#E74856"/>
                                </StackPanel>
                            </ui:SettingsExpanderItem.Footer>
                        </ui:SettingsExpanderItem>
                    </DataTemplate>
                </ui:SettingsExpander.ItemTemplate>
            </ui:SettingsExpander>
        </DataTemplate>
        
        <!-- Standalone Item Template -->
        <DataTemplate x:Key="ItemTemplate" x:DataType="vm:ItemViewModel">
            <views:ItemControl DataContext="{Binding}" Margin="0,0,0,8"/>
        </DataTemplate>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Category Selector -->
        <ListBox Grid.Row="0"
                 ItemsSource="{Binding Categories}"
                 SelectedItem="{Binding SelectedCategory}"
                 Margin="0,0,0,16"
                 Background="Transparent">
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8"/>
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>
            <ListBox.Styles>
                <Style Selector="ListBoxItem">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Margin" Value="0,0,8,0"/>
                    <Setter Property="Template">
                        <ControlTemplate>
                            <Border Name="RootBorder" 
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="4"
                                    Padding="12,8">
                                <ContentPresenter Name="PART_ContentPresenter"
                                                  Content="{TemplateBinding Content}"
                                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter>
                </Style>
                
                <!-- Hover State -->
                <Style Selector="ListBoxItem:pointerover /template/ Border#RootBorder">
                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                </Style>
                
                <!-- Selected State: Accent Background + White Text -->
                <Style Selector="ListBoxItem:selected">
                    <Setter Property="Foreground" Value="White"/>
                </Style>
                <Style Selector="ListBoxItem:selected /template/ Border#RootBorder">
                    <Setter Property="Background" Value="{DynamicResource SystemAccentColor}"/>
                </Style>
                
                <!-- Selected + Hover -->
                <Style Selector="ListBoxItem:selected:pointerover /template/ Border#RootBorder">
                    <Setter Property="Background" Value="{DynamicResource SystemAccentColorLight1}"/>
                </Style>
                
                <!-- Fix for inner background artifact -->
                <Style Selector="ListBoxItem /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                     <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected:pointerover /template/ ContentPresenter">
                     <Setter Property="Background" Value="Transparent"/>
                </Style>
            </ListBox.Styles>
            <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:CategoryViewModel">
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <!-- Items List (Split View) -->
        <ScrollViewer Grid.Row="1"
                      HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="16">
                <!-- User Tweaks Add Area (Full Width) -->
                <ContentControl Content="{Binding SelectedCategory.AddTweakViewModel}"
                                IsVisible="{Binding SelectedCategory.AddTweakViewModel, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate x:DataType="vm:AddTweakViewModel">
                            <views:AddTweakControl/>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>
                
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto">
                    <!-- Left Column -->
                    <ItemsControl Grid.Column="0" ItemsSource="{Binding SelectedCategory.LeftColumnItems}" Margin="0,0,6,0">
                         <ItemsControl.DataTemplates>
                             <DataTemplate x:DataType="vm:ItemGroupViewModel">
                                 <ContentControl Content="{Binding}" ContentTemplate="{StaticResource GroupTemplate}"/>
                             </DataTemplate>
                             <DataTemplate x:DataType="vm:ItemViewModel">
                                 <ContentControl Content="{Binding}" ContentTemplate="{StaticResource ItemTemplate}"/>
                             </DataTemplate>
                         </ItemsControl.DataTemplates>
                    </ItemsControl>
                    
                    <!-- Right Column -->
                    <ItemsControl Grid.Column="1" ItemsSource="{Binding SelectedCategory.RightColumnItems}" Margin="6,0,0,0">
                         <ItemsControl.DataTemplates>
                             <DataTemplate x:DataType="vm:ItemGroupViewModel">
                                 <ContentControl Content="{Binding}" ContentTemplate="{StaticResource GroupTemplate}"/>
                             </DataTemplate>
                             <DataTemplate x:DataType="vm:ItemViewModel">
                                 <ContentControl Content="{Binding}" ContentTemplate="{StaticResource ItemTemplate}"/>
                             </DataTemplate>
                         </ItemsControl.DataTemplates>
                    </ItemsControl>
                </Grid>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
